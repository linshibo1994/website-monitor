# ===========================================
# Arc'teryx 商品监控系统 - Docker Compose
# 作者：linshibo
# ===========================================
# 使用方法:
#   构建并启动: docker compose up -d --build
#   查看日志:   docker compose logs -f
#   查看特定服务日志: docker compose logs -f rakuten-monitor
#   停止服务:   docker compose down
#   执行检测:   docker compose exec monitor python -m backend.app.services.monitor --once
#   库存检查:   docker compose exec inventory-monitor python -m backend.scripts.run_inventory_monitor --once
#   乐天监控状态: docker compose exec rakuten-monitor cat /app/data/rakuten_state.json

services:
  monitor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: arcteryx-monitor
    restart: unless-stopped
    ports:
      - "7080:7080"
    volumes:
      # 持久化数据库和日志
      - ./data:/app/data
      - ./logs:/app/logs
      # 配置文件（可选：如需在容器外修改配置）
      - ./config.yaml:/app/config.yaml:ro
    environment:
      - TZ=Asia/Shanghai
      - PORT=7080
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # 定时监控任务（每10分钟执行一次）
  monitor-scheduler:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: arcteryx-scheduler
    restart: unless-stopped
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./config.yaml:/app/config.yaml:ro
    environment:
      - TZ=Asia/Shanghai
    # 启动守护进程模式
    command: ["python", "-m", "backend.app.services.monitor", "--daemon"]
    depends_on:
      monitor:
        condition: service_healthy

  # Arc'teryx 官网库存监控服务（监控指定商品的尺寸库存变化）
  inventory-monitor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: arcteryx-inventory-monitor
    restart: unless-stopped
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./config.yaml:/app/config.yaml:ro
    environment:
      - TZ=Asia/Shanghai
      - DISPLAY=:99
    # 使用 xvfb-run 运行以支持非 headless 浏览器
    # 每5分钟检查一次库存
    command: >
      bash -c "
        Xvfb :99 -screen 0 1920x1080x24 &
        sleep 2
        python -m backend.scripts.run_inventory_monitor --daemon --interval 5
      "
    depends_on:
      monitor:
        condition: service_healthy

  # 乐天商品监控服务（监控指定商品页面是否从404恢复可用）
  rakuten-monitor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rakuten-monitor
    restart: unless-stopped
    # 使用宿主机网络模式，解决 DNS 和网络问题
    network_mode: "host"
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./config.yaml:/app/config.yaml:ro
    environment:
      - TZ=Asia/Shanghai
      # 可选：通过环境变量覆盖邮件配置
      # - MONITOR_SENDER_EMAIL=your_email@qq.com
      # - MONITOR_SENDER_PASSWORD=your_password
      # - MONITOR_RECIPIENTS=receiver@example.com
    # 直接运行监控脚本（内置循环，默认5分钟检查一次）
    command: ["python", "-m", "backend.scripts.rakuten_monitor_task"]

networks:
  default:
    name: arcteryx-monitor-network
