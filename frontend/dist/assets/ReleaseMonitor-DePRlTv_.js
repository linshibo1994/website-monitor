import{r as g,N as se,j as oe,O as ne,c as k,o as m,b as a,w as t,d as i,a5 as ie,E as f,P as re,a as s,f as c,a6 as I,t as u,a7 as $,a8 as ce,F as B,i as r,R as de,B as N,S as ue,T as _e,U as pe,V as fe,H as me,W as ve,X as ge,a9 as ye,aa as be,$ as ke,ab as he,ac as we,ad as Ce}from"./index-D7RlJP8t.js";import{_ as xe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Re={class:"release-monitor-view"},Ve={class:"stat-card"},Pe={class:"icon-wrapper bg-blue"},De={class:"content"},Se={class:"value"},Te={class:"stat-card"},Ue={class:"icon-wrapper bg-orange"},Ie={class:"content"},$e={class:"value"},Be={class:"stat-card"},Ne={class:"icon-wrapper bg-green"},Me={class:"content"},Ee={class:"value"},Le={class:"card-header"},We={class:"header-title"},ze={class:"product-name-cell"},Ae={class:"name-text"},je={key:0,class:"release-time"},Fe={key:1,class:"text-gray"},He={key:1,class:"text-gray"},Oe={class:"text-gray"},Xe={key:0,class:"parse-success-card"},qe={class:"header"},Ge={class:"info-grid"},Je={class:"item"},Ke={class:"item"},Qe={key:1,class:"parse-error-msg"},Ye={__name:"ReleaseMonitor",setup(Ze){const h=g({total:0,active:0,coming_soon:0,available:0,unavailable:0,error:0,notified:0,products:[]}),C=g(!1),x=g(!1),R=g(!1),w=g(!1);let V=null,P=null;const p=g({url:"",name:""}),d=g({success:!1,error:null}),M=se(()=>d.value.success||p.value.url&&!d.value.error),y=async()=>{try{const l=await ie();h.value=l.data}catch(l){console.error(l),f.error("获取监控状态失败")}},E=async()=>{var l,e;x.value=!0;try{const n=await ye();f.success(`检测完成: ${n.data.available} 个已上线, ${n.data.coming_soon} 个待上线`),await y()}catch(n){f.error(((e=(l=n.response)==null?void 0:l.data)==null?void 0:e.detail)||"检测失败")}finally{x.value=!1}},L=async l=>{var e,n;l._checking=!0;try{await be(l.id),f.success("检测完成"),await y()}catch(_){f.error(((n=(e=_.response)==null?void 0:e.data)==null?void 0:n.detail)||"检测失败")}finally{l._checking=!1}},W=()=>{P&&clearTimeout(P),P=setTimeout(z,500)},z=async()=>{var e,n;const l=p.value.url.trim();if(!l){d.value={success:!1,error:null};return}if(!l.startsWith("http://")&&!l.startsWith("https://")){d.value={success:!1,error:"请输入完整的URL (http:// 或 https://)"};return}try{const _=await Ce(l);d.value=_.data}catch(_){d.value={success:!1,error:((n=(e=_.response)==null?void 0:e.data)==null?void 0:n.detail)||"无法解析"}}},A=async()=>{var l,e;R.value=!0;try{await we({url:p.value.url,name:p.value.name||null}),f.success("添加成功"),w.value=!1,await y()}catch(n){f.error(((e=(l=n.response)==null?void 0:l.data)==null?void 0:e.detail)||"添加失败")}finally{R.value=!1}},j=async l=>{try{await ke.confirm("确定移除该商品的上线监控吗?","警告",{type:"warning"}),await he(l.id),f.success("已移除"),y()}catch(e){e!=="cancel"&&(e==null?void 0:e.message)!=="cancel"&&f.error("移除失败")}},F=l=>window.open(l,"_blank"),H=l=>l?new Date(l).toLocaleString("zh-CN",{month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"}):"从未",O=l=>({daytona_park:"Daytona Park",rakuten:"Rakuten"})[l]||l,X=l=>({available:"success",coming_soon:"warning",unavailable:"danger",error:"danger"})[l]||"info",q=l=>({available:"已上线",coming_soon:"即将上线",unavailable:"不可用",error:"错误"})[l]||l,G=()=>{p.value={url:"",name:""},d.value={success:!1},w.value=!0},J=()=>{};return oe(()=>{C.value=!0,y().finally(()=>C.value=!1),V=setInterval(y,3e4)}),ne(()=>{V&&clearInterval(V)}),(l,e)=>{const n=i("el-icon"),_=i("el-col"),v=i("el-button"),K=i("el-row"),D=i("el-tag"),b=i("el-table-column"),Q=i("el-button-group"),Y=i("el-empty"),Z=i("el-table"),ee=i("el-card"),S=i("el-input"),T=i("el-form-item"),ae=i("el-form"),te=i("el-dialog"),le=re("loading");return m(),k("div",Re,[a(K,{gutter:20,class:"overview-row"},{default:t(()=>[a(_,{span:6},{default:t(()=>[s("div",Ve,[s("div",Pe,[a(n,null,{default:t(()=>[a(c(I))]),_:1})]),s("div",De,[s("div",Se,u(h.value.total),1),e[4]||(e[4]=s("div",{class:"label"},"监控商品",-1))])])]),_:1}),a(_,{span:6},{default:t(()=>[s("div",Te,[s("div",Ue,[a(n,null,{default:t(()=>[a(c($))]),_:1})]),s("div",Ie,[s("div",$e,u(h.value.coming_soon),1),e[5]||(e[5]=s("div",{class:"label"},"即将上线",-1))])])]),_:1}),a(_,{span:6},{default:t(()=>[s("div",Be,[s("div",Ne,[a(n,null,{default:t(()=>[a(c(ce))]),_:1})]),s("div",Me,[s("div",Ee,u(h.value.available),1),e[6]||(e[6]=s("div",{class:"label"},"已上线",-1))])])]),_:1}),a(_,{span:6,class:"actions-col"},{default:t(()=>[a(v,{type:"primary",loading:x.value,onClick:E,icon:c(B),class:"action-btn"},{default:t(()=>[...e[7]||(e[7]=[r(" 立即检测 ",-1)])]),_:1},8,["loading","icon"])]),_:1})]),_:1}),a(ee,{class:"table-card",shadow:"never"},{header:t(()=>[s("div",Le,[s("div",We,[a(n,null,{default:t(()=>[a(c(pe))]),_:1}),e[8]||(e[8]=s("span",null,"上线监控列表",-1))]),a(v,{type:"primary",icon:c(fe),onClick:G},{default:t(()=>[...e[9]||(e[9]=[r(" 添加商品 ",-1)])]),_:1},8,["icon"])])]),default:t(()=>[de((m(),N(Z,{data:h.value.products,style:{width:"100%"},"row-key":"id"},{empty:t(()=>[a(Y,{description:"暂无监控商品"})]),default:t(()=>[a(b,{prop:"name",label:"商品名称","min-width":"200"},{default:t(({row:o})=>[s("div",ze,[s("span",Ae,u(o.name||"正在获取..."),1),a(D,{size:"small",effect:"plain",type:"info"},{default:t(()=>[r(u(O(o.website_type)),1)]),_:2},1024)])]),_:1}),a(b,{prop:"status",label:"状态",width:"120",align:"center"},{default:t(({row:o})=>[a(D,{type:X(o.status),effect:"light"},{default:t(()=>[r(u(q(o.status)),1)]),_:2},1032,["type"])]),_:1}),a(b,{prop:"scheduled_release_time",label:"预计上线",width:"180"},{default:t(({row:o})=>[o.scheduled_release_time?(m(),k("span",je,[a(n,null,{default:t(()=>[a(c($))]),_:1}),r(" "+u(o.scheduled_release_time),1)])):(m(),k("span",Fe,"未知"))]),_:1}),a(b,{prop:"notification_sent",label:"通知",width:"100",align:"center"},{default:t(({row:o})=>[o.notification_sent?(m(),N(D,{key:0,type:"success",size:"small",effect:"plain"},{default:t(()=>[a(n,null,{default:t(()=>[a(c(I))]),_:1}),e[10]||(e[10]=r(" 已发送 ",-1))]),_:1})):(m(),k("span",He,"-"))]),_:1}),a(b,{label:"最后检测",width:"160"},{default:t(({row:o})=>[s("span",Oe,u(H(o.last_check_time)),1)]),_:1}),a(b,{label:"操作",width:"200",align:"right"},{default:t(({row:o})=>[a(Q,null,{default:t(()=>[a(v,{link:"",type:"primary",icon:c(ue),onClick:U=>F(o.url)},{default:t(()=>[...e[11]||(e[11]=[r("访问",-1)])]),_:1},8,["icon","onClick"]),a(v,{link:"",type:"primary",icon:c(B),onClick:U=>L(o),loading:o._checking},{default:t(()=>[...e[12]||(e[12]=[r("检测",-1)])]),_:1},8,["icon","onClick","loading"]),a(v,{link:"",type:"danger",icon:c(_e),onClick:U=>j(o)},{default:t(()=>[...e[13]||(e[13]=[r("移除",-1)])]),_:1},8,["icon","onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[le,C.value]])]),_:1}),a(te,{modelValue:w.value,"onUpdate:modelValue":e[3]||(e[3]=o=>w.value=o),title:"添加上线监控商品",width:"550px",onClose:J,"destroy-on-close":""},{footer:t(()=>[a(v,{onClick:e[2]||(e[2]=o=>w.value=!1)},{default:t(()=>[...e[18]||(e[18]=[r("取消",-1)])]),_:1}),a(v,{type:"primary",onClick:A,loading:R.value,disabled:!M.value},{default:t(()=>[...e[19]||(e[19]=[r(" 开始监控 ",-1)])]),_:1},8,["loading","disabled"])]),default:t(()=>[a(ae,{"label-position":"top"},{default:t(()=>[a(T,{label:"商品链接 (URL)"},{default:t(()=>[a(S,{modelValue:p.value.url,"onUpdate:modelValue":e[0]||(e[0]=o=>p.value.url=o),placeholder:"输入 Daytona Park 或 Rakuten 商品链接","prefix-icon":c(ve),onInput:W,clearable:""},null,8,["modelValue","prefix-icon"]),e[14]||(e[14]=s("div",{class:"tip-text"},"支持 Daytona Park 和 Rakuten 日本网站",-1))]),_:1}),d.value.success?(m(),k("div",Xe,[s("div",qe,[a(n,null,{default:t(()=>[a(c(ge))]),_:1}),e[15]||(e[15]=r(" 识别成功 ",-1))]),s("div",Ge,[s("div",Je,[e[16]||(e[16]=s("span",{class:"label"},"网站:",-1)),r(" "+u(d.value.website_name),1)]),s("div",Ke,[e[17]||(e[17]=s("span",{class:"label"},"商品ID:",-1)),r(" "+u(d.value.product_id||"未知"),1)])])])):d.value.error?(m(),k("div",Qe,u(d.value.error),1)):me("",!0),a(T,{label:"商品名称（可选）"},{default:t(()=>[a(S,{modelValue:p.value.name,"onUpdate:modelValue":e[1]||(e[1]=o=>p.value.name=o),placeholder:"默认自动获取"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}},ta=xe(Ye,[["__scopeId","data-v-c81a722c"]]);export{ta as default};
