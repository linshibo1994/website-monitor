import{r as z,c as N,o as we,x as he,a as y,b as i,d as l,j as n,w as t,e as v,l as k,p as C,m as p,y as _,z as Ve,A as ze,B as Se,t as m,k as Ce,C as Q,D as Y,G as q,H as xe,I as Ie,F as U,q as R,J as Ue,K as Le,L as Te,M as Be,N as Xe,O as Pe,P as Re,Q as De,R as F,E as b,S as Ke,T as Ee,U as Me,V as Ae,W as Ne,X as qe,Y as Fe}from"./index-BQ5_eiXI.js";import{_ as $e}from"./_plugin-vue_export-helper-DlAUqK2U.js";const je={class:"inventory-container"},He={class:"stat-item"},We={class:"stat-content"},Ge={class:"stat-value"},Je={class:"stat-item"},Oe={class:"stat-content"},Qe={class:"stat-value"},Ye={class:"stat-item"},Ze={class:"stat-content"},el={class:"stat-value"},ll={class:"stat-item control-buttons"},tl={class:"products-section"},al={class:"section-header"},sl={class:"product-header"},nl={class:"product-info"},ol={class:"product-name"},ul={class:"product-meta"},rl={key:0,class:"target-sizes"},il={key:0,class:"coming-soon-notice"},dl={class:"product-footer"},cl={key:0,class:"check-time"},_l={class:"parse-info"},vl={class:"parse-details"},pl={class:"detail-item"},fl={class:"detail-item"},ml={key:0,class:"detail-item"},yl={class:"preview-url"},gl={class:"parse-info"},kl={class:"error-message"},bl={key:0,class:"manual-fallback"},wl={class:"manual-inputs"},hl={class:"manual-tip"},Vl={key:0},zl={__name:"Inventory",setup(Sl){const w=z({is_running:!1,last_check_time:null,monitored_products:0,products:[]}),M=z(!1),D=z(!1),B=z(!1),x=z([]),r=z({success:!1,site_id:null,site_name:null,key:null,category:null,url:null,error:null,categories:null}),S=z(""),u=z({input:"",name:"",category:"",target_sizes:[],target_colors:[]}),c=z({site_id:"",key:"",category:""});let K=null,V=null,E=0;const $=N(()=>{if(!c.value.site_id)return[];const a=x.value.find(e=>e.site_id===c.value.site_id);return(a==null?void 0:a.categories)||[]}),j=N(()=>{if(!c.value.site_id)return"";const a=x.value.find(e=>e.site_id===c.value.site_id);return(a==null?void 0:a.key_example)||""}),Z=N(()=>!!(r.value.success||c.value.site_id&&c.value.key||u.value.input.trim())),ee=async()=>{H(),B.value=!0,await te()},le=()=>{V&&(clearTimeout(V),V=null),E++},te=async()=>{try{const a=await Fe();x.value=a.data.sites||[]}catch(a){console.error("获取站点列表失败:",a)}},H=()=>{u.value={input:"",name:"",category:"",target_sizes:[],target_colors:[]},r.value={success:!1,site_id:null,site_name:null,key:null,category:null,url:null,error:null,categories:null},c.value={site_id:"",key:"",category:""},S.value=""},ae=()=>{V&&clearTimeout(V),V=setTimeout(async()=>{await se()},300)},se=async()=>{var o,d;const a=u.value.input.trim(),e=++E;if(!a){r.value={success:!1,site_id:null,site_name:null,key:null,category:null,url:null,error:null,categories:null},S.value="";return}try{const f=await qe(a);if(e!==E)return;r.value=f.data,r.value.success&&(r.value.category&&(u.value.category=r.value.category),S.value=r.value.url||"")}catch(f){if(e!==E)return;r.value={success:!1,error:((d=(o=f.response)==null?void 0:o.data)==null?void 0:d.detail)||"解析失败"}}},ne=()=>{if(!r.value.success)return;const a=x.value.find(d=>d.site_id===r.value.site_id);if(!a||!a.url_templates){S.value=r.value.url||"";return}const e=u.value.category||r.value.category,o=a.url_templates[e]||a.url_templates.default||"";o&&r.value.key?S.value=o.replace("{key}",r.value.key):S.value=r.value.url||""},oe=()=>{const a=x.value.find(e=>e.site_id===c.value.site_id);a&&(c.value.category=a.default_category||"")},I=async()=>{try{const a=await ze();w.value=a.data}catch(a){console.error("获取库存监控状态失败:",a)}},ue=async()=>{var a,e;M.value=!0;try{const o=await F();b.success(`检查完成: ${o.data.products_checked} 个商品, ${o.data.changes_detected} 个变化`),await I()}catch(o){b.error(((e=(a=o.response)==null?void 0:a.data)==null?void 0:e.detail)||"检查失败")}finally{M.value=!1}},re=async()=>{var a,e;try{w.value.is_running?(await Ke(),b.success("库存监控已停止")):(await Ee(),b.success("库存监控已启动")),await I()}catch(o){b.error(((e=(a=o.response)==null?void 0:a.data)==null?void 0:e.detail)||"操作失败")}},ie=async(a=90)=>{var d;const e=Date.now(),o=5e3;for(;Date.now()-e<a*1e3;){await new Promise(f=>setTimeout(f,o)),await I();try{return await F(),!0}catch(f){if(((d=f.response)==null?void 0:d.status)===409){console.log("检查进行中，等待...");continue}return!1}}return!1},de=async()=>{var a,e,o;D.value=!0;try{let d={};if(r.value.success)d={input:u.value.input,name:u.value.name,category:u.value.category,target_sizes:u.value.target_sizes,target_colors:u.value.target_colors};else if(c.value.site_id&&c.value.key)d={site_id:c.value.site_id,key:c.value.key,category:c.value.category,name:u.value.name,target_sizes:u.value.target_sizes,target_colors:u.value.target_colors};else if(u.value.input.trim())d={input:u.value.input,name:u.value.name,target_sizes:u.value.target_sizes,target_colors:u.value.target_colors};else{b.warning("请输入商品URL或Key"),D.value=!1;return}await Ne(d),b.success("商品添加成功，正在获取商品信息..."),B.value=!1,H();try{await F(),b.success("商品信息已更新")}catch(f){((a=f.response)==null?void 0:a.status)===409?(b.info("有检查任务正在进行，等待完成..."),await ie(60),b.success("商品信息已更新")):console.error("自动检查失败:",f)}await I()}catch(d){b.error(((o=(e=d.response)==null?void 0:e.data)==null?void 0:o.detail)||"添加失败")}finally{D.value=!1}},ce=async a=>{var e,o;try{await Me.confirm("确定要移除该商品的监控吗？","确认",{type:"warning"}),await Ae(a),b.success("商品已移除"),await I()}catch(d){d!=="cancel"&&b.error(((o=(e=d.response)==null?void 0:e.data)==null?void 0:o.detail)||"移除失败")}},W=a=>a?new Date(a).toLocaleString("zh-CN"):"从未",_e=a=>a.includes("scheels.com")?"Scheels":a.includes("arcteryx.com")?"Arc'teryx官网":"其他",ve=(a,e)=>!e||e.length===0?!1:e.includes(a),pe=a=>{switch(a){case"available":return"success";case"coming_soon":return"warning";case"unavailable":return"danger";default:return"info"}},fe=a=>{switch(a){case"available":return"已上架";case"coming_soon":return"即将上架";case"unavailable":return"已下架";default:return"未知"}};return we(()=>{I(),K=setInterval(I,3e4)}),he(()=>{K&&(clearInterval(K),K=null),V&&(clearTimeout(V),V=null)}),(a,e)=>{const o=v("el-icon"),d=v("el-card"),f=v("el-col"),L=v("el-button"),G=v("el-row"),T=v("el-tag"),J=v("el-table-column"),me=v("el-table"),O=v("el-link"),ye=v("el-empty"),A=v("el-input"),X=v("el-form-item"),g=v("el-option"),P=v("el-select"),ge=v("el-divider"),ke=v("el-form"),be=v("el-dialog");return i(),y("div",je,[l(G,{gutter:20,class:"status-row"},{default:t(()=>[l(f,{span:6},{default:t(()=>[l(d,{class:"status-card",shadow:"hover"},{default:t(()=>[n("div",He,[l(o,{class:"stat-icon",style:{background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)"}},{default:t(()=>[l(_(Se))]),_:1}),n("div",We,[n("div",Ge,m(w.value.monitored_products),1),e[10]||(e[10]=n("div",{class:"stat-label"},"监控商品数",-1))])])]),_:1})]),_:1}),l(f,{span:6},{default:t(()=>[l(d,{class:"status-card",shadow:"hover"},{default:t(()=>[n("div",Je,[l(o,{class:"stat-icon",style:Ce({background:w.value.is_running?"linear-gradient(135deg, #11998e 0%, #38ef7d 100%)":"linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)"})},{default:t(()=>[w.value.is_running?(i(),k(_(Q),{key:0})):(i(),k(_(Y),{key:1}))]),_:1},8,["style"]),n("div",Oe,[n("div",Qe,m(w.value.is_running?"运行中":"已停止"),1),e[11]||(e[11]=n("div",{class:"stat-label"},"监控状态",-1))])])]),_:1})]),_:1}),l(f,{span:6},{default:t(()=>[l(d,{class:"status-card",shadow:"hover"},{default:t(()=>[n("div",Ye,[l(o,{class:"stat-icon",style:{background:"linear-gradient(135deg, #f093fb 0%, #f5576c 100%)"}},{default:t(()=>[l(_(q))]),_:1}),n("div",Ze,[n("div",el,m(W(w.value.last_check_time)),1),e[12]||(e[12]=n("div",{class:"stat-label"},"上次检查",-1))])])]),_:1})]),_:1}),l(f,{span:6},{default:t(()=>[l(d,{class:"status-card",shadow:"hover"},{default:t(()=>[n("div",ll,[l(L,{type:"primary",loading:M.value,onClick:ue,icon:_(xe)},{default:t(()=>[...e[13]||(e[13]=[p(" 立即检查 ",-1)])]),_:1},8,["loading","icon"]),l(L,{type:w.value.is_running?"danger":"success",onClick:re,icon:w.value.is_running?_(Y):_(Q)},{default:t(()=>[p(m(w.value.is_running?"停止监控":"启动监控"),1)]),_:1},8,["type","icon"])])]),_:1})]),_:1})]),_:1}),n("div",tl,[n("div",al,[n("h3",null,[l(o,null,{default:t(()=>[l(_(Ie))]),_:1}),e[14]||(e[14]=p(" 商品库存监控",-1))]),l(L,{type:"primary",size:"small",icon:_(Ve),onClick:ee},{default:t(()=>[...e[15]||(e[15]=[p(" 添加商品 ",-1)])]),_:1},8,["icon"])]),l(G,{gutter:20},{default:t(()=>[(i(!0),y(U,null,R(w.value.products,s=>(i(),k(f,{span:12,key:s.url},{default:t(()=>[l(d,{class:"product-card",shadow:"hover"},{header:t(()=>[n("div",sl,[n("div",nl,[n("h4",ol,m(s.name||"未知商品"),1),n("div",ul,[l(T,{size:"small",type:"info"},{default:t(()=>[p(m(_e(s.url)),1)]),_:2},1024),l(T,{size:"small",type:pe(s.status),effect:"dark"},{default:t(()=>[p(m(fe(s.status)),1)]),_:2},1032,["type"]),s.target_sizes.length>0?(i(),y("span",rl,[e[16]||(e[16]=p(" 目标尺码: ",-1)),(i(!0),y(U,null,R(s.target_sizes,h=>(i(),k(T,{size:"small",key:h,type:"warning"},{default:t(()=>[p(m(h),1)]),_:2},1024))),128))])):C("",!0)])]),l(L,{type:"danger",size:"small",icon:_(Be),circle:"",onClick:h=>ce(s.url)},null,8,["icon","onClick"])])]),default:t(()=>[s.status==="coming_soon"?(i(),y("div",il,[l(o,null,{default:t(()=>[l(_(q))]),_:1}),e[17]||(e[17]=n("span",null,"商品即将上架，正在监控中...",-1))])):(i(),k(me,{key:1,data:s.variants,size:"small",stripe:""},{default:t(()=>[l(J,{prop:"size",label:"尺码",width:"100",align:"center"},{default:t(({row:h})=>[l(T,{type:ve(h.size,s.target_sizes)?"warning":"info",size:"small"},{default:t(()=>[p(m(h.size),1)]),_:2},1032,["type"])]),_:2},1024),l(J,{prop:"stock_status",label:"库存状态",align:"center"},{default:t(({row:h})=>[l(T,{type:h.is_available?"success":"danger",effect:"dark"},{default:t(()=>[h.is_available?(i(),k(o,{key:0},{default:t(()=>[l(_(Ue))]),_:1})):(i(),k(o,{key:1},{default:t(()=>[l(_(Le))]),_:1})),p(" "+m(h.is_available?"有货":"缺货"),1)]),_:2},1032,["type"])]),_:1})]),_:2},1032,["data"])),n("div",dl,[s.last_check_time?(i(),y("div",cl,[l(o,null,{default:t(()=>[l(_(q))]),_:1}),p(" 检查时间: "+m(W(s.last_check_time)),1)])):C("",!0),l(O,{href:s.url,target:"_blank",type:"primary"},{default:t(()=>[l(o,null,{default:t(()=>[l(_(Te))]),_:1}),e[18]||(e[18]=p(" 查看商品 ",-1))]),_:1},8,["href"])])]),_:2},1024)]),_:2},1024))),128))]),_:1}),w.value.products.length===0?(i(),k(ye,{key:0,description:"暂无监控商品，请添加商品开始监控"})):C("",!0)]),l(be,{modelValue:B.value,"onUpdate:modelValue":e[9]||(e[9]=s=>B.value=s),title:"添加监控商品",width:"600px",onClose:le},{footer:t(()=>[l(L,{onClick:e[8]||(e[8]=s=>B.value=!1)},{default:t(()=>[...e[29]||(e[29]=[p("取消",-1)])]),_:1}),l(L,{type:"primary",onClick:de,loading:D.value,disabled:!Z.value},{default:t(()=>[...e[30]||(e[30]=[p(" 添加监控 ",-1)])]),_:1},8,["loading","disabled"])]),default:t(()=>[l(ke,{model:u.value,"label-width":"100px"},{default:t(()=>[l(X,{label:"商品URL/Key",required:""},{default:t(()=>[l(A,{modelValue:u.value.input,"onUpdate:modelValue":e[0]||(e[0]=s=>u.value.input=s),placeholder:"粘贴商品URL 或 输入商品Key",onInput:ae,clearable:""},{prefix:t(()=>[l(o,null,{default:t(()=>[l(_(Xe))]),_:1})]),_:1},8,["modelValue"]),e[19]||(e[19]=n("div",{class:"input-tips"},[n("span",null,"支持: Arc'teryx URL/Key (如 beta-sl-jacket-9685), SCHEELS URL/Key (如 62355529822)")],-1))]),_:1}),r.value.success||r.value.error?(i(),k(X,{key:0},{default:t(()=>[n("div",{class:Pe(["parse-result",{success:r.value.success,error:!r.value.success}])},[r.value.success?(i(),y(U,{key:0},[n("div",_l,[l(o,null,{default:t(()=>[l(_(Re))]),_:1}),e[20]||(e[20]=n("span",{class:"parse-label"},"识别成功",-1))]),n("div",vl,[n("div",pl,[e[21]||(e[21]=n("span",{class:"label"},"站点:",-1)),l(T,{size:"small",type:"primary"},{default:t(()=>[p(m(r.value.site_name),1)]),_:1})]),n("div",fl,[e[22]||(e[22]=n("span",{class:"label"},"Key:",-1)),n("code",null,m(r.value.key),1)]),r.value.categories&&r.value.categories.length>0?(i(),y("div",ml,[e[23]||(e[23]=n("span",{class:"label"},"分类:",-1)),l(P,{modelValue:u.value.category,"onUpdate:modelValue":e[1]||(e[1]=s=>u.value.category=s),size:"small",style:{width:"120px"},onChange:ne},{default:t(()=>[(i(!0),y(U,null,R(r.value.categories,s=>(i(),k(g,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])):C("",!0)]),n("div",yl,[e[24]||(e[24]=n("span",{class:"label"},"预览URL:",-1)),l(O,{href:S.value,target:"_blank",type:"primary",underline:!1},{default:t(()=>[p(m(S.value),1)]),_:1},8,["href"])])],64)):(i(),y(U,{key:1},[n("div",gl,[l(o,null,{default:t(()=>[l(_(De))]),_:1}),e[25]||(e[25]=n("span",{class:"parse-label"},"识别失败",-1))]),n("div",kl,m(r.value.error),1),x.value.length>0?(i(),y("div",bl,[l(ge,{"content-position":"left"},{default:t(()=>[...e[26]||(e[26]=[p("手动指定",-1)])]),_:1}),n("div",wl,[l(P,{modelValue:c.value.site_id,"onUpdate:modelValue":e[2]||(e[2]=s=>c.value.site_id=s),placeholder:"选择站点",size:"small",style:{width:"150px"},onChange:oe},{default:t(()=>[(i(!0),y(U,null,R(x.value,s=>(i(),k(g,{key:s.site_id,label:s.name,value:s.site_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),l(A,{modelValue:c.value.key,"onUpdate:modelValue":e[3]||(e[3]=s=>c.value.key=s),placeholder:"输入商品Key",size:"small",style:{width:"200px","margin-left":"10px"}},null,8,["modelValue"]),$.value.length>0?(i(),k(P,{key:0,modelValue:c.value.category,"onUpdate:modelValue":e[4]||(e[4]=s=>c.value.category=s),placeholder:"分类",size:"small",style:{width:"100px","margin-left":"10px"}},{default:t(()=>[(i(!0),y(U,null,R($.value,s=>(i(),k(g,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])):C("",!0)]),n("div",hl,[j.value?(i(),y("span",Vl,"示例 Key: "+m(j.value),1)):C("",!0)])])):C("",!0)],64))],2)]),_:1})):C("",!0),l(X,{label:"商品名称"},{default:t(()=>[l(A,{modelValue:u.value.name,"onUpdate:modelValue":e[5]||(e[5]=s=>u.value.name=s),placeholder:"可选，留空则自动获取"},null,8,["modelValue"])]),_:1}),l(X,{label:"目标尺码"},{default:t(()=>[l(P,{modelValue:u.value.target_sizes,"onUpdate:modelValue":e[6]||(e[6]=s=>u.value.target_sizes=s),multiple:"",placeholder:"选择要监控的尺码",style:{width:"100%"}},{default:t(()=>[l(g,{label:"XS",value:"XS"}),l(g,{label:"S",value:"S"}),l(g,{label:"M",value:"M"}),l(g,{label:"L",value:"L"}),l(g,{label:"XL",value:"XL"}),l(g,{label:"2XL",value:"2XL"}),l(g,{label:"XXL",value:"XXL"})]),_:1},8,["modelValue"]),e[27]||(e[27]=n("div",{class:"form-tip"},"留空则监控所有尺码",-1))]),_:1}),l(X,{label:"目标颜色"},{default:t(()=>[l(P,{modelValue:u.value.target_colors,"onUpdate:modelValue":e[7]||(e[7]=s=>u.value.target_colors=s),multiple:"",filterable:"","allow-create":"","default-first-option":"",placeholder:"输入颜色名称 (如 Black, Void)",style:{width:"100%"}},{default:t(()=>[l(g,{label:"Black",value:"Black"}),l(g,{label:"Void",value:"Void"}),l(g,{label:"Black Sapphire",value:"Black Sapphire"})]),_:1},8,["modelValue"]),e[28]||(e[28]=n("div",{class:"form-tip"},"留空则监控所有颜色，可手动输入颜色名称",-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Il=$e(zl,[["__scopeId","data-v-dd8e047a"]]);export{Il as default};
