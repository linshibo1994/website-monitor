import{r as f,N as Se,j as Ue,O as Pe,c as m,o as u,b as t,w as a,d as r,n as Te,P as De,a as n,f as g,Q as Fe,t as v,A as Ae,B as h,C as Y,D as Z,z as Ne,F as Re,i as _,R as Be,H as S,I as A,J as N,S as $e,T as qe,U as Ee,V as Le,W as Me,X as Ke,Y as je,E as k,Z as We,_ as He,$ as Je,a0 as Oe,a1 as Qe,a2 as Xe,a3 as Ye,a4 as Ze}from"./index-D7RlJP8t.js";import{_ as Ge}from"./_plugin-vue_export-helper-DlAUqK2U.js";const et={class:"inventory-view"},tt={class:"stat-card"},at={class:"icon-wrapper bg-blue"},lt={class:"content"},st={class:"value"},nt={class:"stat-card"},ot={class:"content"},rt={class:"value"},it={class:"stat-card"},ut={class:"icon-wrapper bg-purple"},dt={class:"content"},ct={class:"value"},_t={class:"card-header"},vt={class:"header-title"},pt={class:"variants-container"},ft={key:0,class:"coming-soon-alert"},gt={class:"product-name-cell"},mt={class:"name-text"},yt={class:"tags-wrapper"},bt={key:0,class:"text-gray"},ht={class:"text-gray"},kt={class:"tab-content"},wt={key:0,class:"parse-success-card"},Vt={class:"header"},zt={class:"info-grid"},Ct={class:"item"},xt={class:"item"},It={key:0,class:"item full"},St={class:"preview-link"},Ut={key:1,class:"parse-error-msg"},Pt={key:0,class:"tip-text"},Tt={key:0,class:"color-hint"},Dt={__name:"Inventory",setup(Ft){const y=f({is_running:!1,last_check_time:null,monitored_products:0,products:[]}),R=f(!1),B=f(!1),$=f(!1),C=f(!1),q=f("smart"),V=f([]),U=f(!1),z=f([]),P=f(!1);let E=null,T=0,D=0;const i=f({input:"",name:"",category:"",target_sizes:[],target_colors:[]}),p=f({success:!1,error:null}),L=f("");let M=null;const G=Se(()=>q.value==="manual"?!!i.value.input:p.value.success||i.value.input&&!p.value.error),x=async()=>{try{const l=await Te();y.value=l.data}catch(l){console.error(l)}},j=async()=>{var l,e;B.value=!0;try{const o=await je();k.success(`检查完成: 变动 ${o.data.changes_detected}`),await x()}catch(o){k.error(((e=(l=o.response)==null?void 0:l.data)==null?void 0:e.detail)||"检查失败")}finally{B.value=!1}},ee=async()=>{try{y.value.is_running?(await We(),k.success("监控已停止")):(await He(),k.success("监控已启动")),await x()}catch{k.error("操作失败")}},te=()=>{M&&clearTimeout(M),M=setTimeout(ae,500)},ae=async()=>{var e,o;const l=i.value.input.trim();if(V.value=[],z.value=[],!l){p.value={success:!1,error:null};return}try{const d=await Xe(l);p.value=d.data,d.data.success&&(L.value=d.data.url,d.data.category&&(i.value.category=d.data.category),d.data.url&&(le(d.data.url),se(d.data.url)))}catch(d){p.value={success:!1,error:((o=(e=d.response)==null?void 0:e.data)==null?void 0:o.detail)||"无法解析"}}},le=async l=>{const e=++T;U.value=!0;try{const o=await Ye(l);if(e!==T)return;o.data.success&&o.data.colors&&(V.value=o.data.colors)}catch(o){if(e!==T)return;console.error("获取颜色失败:",o),V.value=[]}finally{e===T&&(U.value=!1)}},se=async l=>{const e=++D;P.value=!0;try{const o=await Ze(l);if(e!==D)return;z.value=Array.isArray(o.data)?o.data:[]}catch(o){if(e!==D)return;console.error("获取尺码失败:",o),z.value=[]}finally{e===D&&(P.value=!1)}},ne=()=>{},oe=async()=>{var l,e;$.value=!0;try{await Qe({input:i.value.input,name:i.value.name,category:i.value.category,target_sizes:i.value.target_sizes,target_colors:i.value.target_colors}),k.success("添加成功"),C.value=!1,j()}catch(o){k.error(((e=(l=o.response)==null?void 0:l.data)==null?void 0:e.detail)||"添加失败")}finally{$.value=!1}},re=async l=>{try{await Je.confirm("确定移除该商品吗?","警告",{type:"warning"}),await Oe(l),k.success("已移除"),x()}catch{}},ie=l=>window.open(l,"_blank"),W=l=>l?new Date(l).toLocaleString("zh-CN",{month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"}):"从未",ue=l=>l.includes("scheels")?"Scheels":l.includes("arcteryx")?"Arc'teryx":"Site",de=(l,e)=>!e||!e.length?!0:e.includes(l),ce=l=>{var o;if(console.log("[getFilteredVariants] row.target_colors:",l.target_colors),console.log("[getFilteredVariants] row.variants count:",(o=l.variants)==null?void 0:o.length),!l.variants||!l.variants.length)return[];if(!l.target_colors||!l.target_colors.length)return console.log("[getFilteredVariants] No target_colors, returning all variants"),l.variants;const e=l.variants.filter(d=>d.color_name&&l.target_colors.includes(d.color_name));return console.log("[getFilteredVariants] Filtered count:",e.length),e},_e=l=>({available:"success",coming_soon:"warning",unavailable:"danger"})[l]||"info",ve=l=>({available:"现货",coming_soon:"即将上架",unavailable:"缺货"})[l]||l,pe=()=>{i.value={input:"",name:"",category:"",target_sizes:[],target_colors:[]},p.value={success:!1},V.value=[],z.value=[],C.value=!0},fe=()=>{};return Ue(()=>{R.value=!0,x().finally(()=>R.value=!1),E=setInterval(x,3e4)}),Pe(()=>{E&&clearInterval(E)}),(l,e)=>{const o=r("el-icon"),d=r("el-col"),w=r("el-button"),ge=r("el-row"),me=r("el-alert"),I=r("el-tag"),b=r("el-table-column"),H=r("el-table"),ye=r("el-button-group"),be=r("el-empty"),he=r("el-card"),K=r("el-input"),ke=r("el-radio-button"),we=r("el-radio-group"),Ve=r("el-link"),J=r("el-tab-pane"),F=r("el-form-item"),O=r("el-form"),ze=r("el-tabs"),Ce=r("el-divider"),Q=r("el-option"),X=r("el-select"),xe=r("el-dialog"),Ie=De("loading");return u(),m("div",et,[t(ge,{gutter:20,class:"overview-row"},{default:a(()=>[t(d,{span:6},{default:a(()=>[n("div",tt,[n("div",at,[t(o,null,{default:a(()=>[t(g(Fe))]),_:1})]),n("div",lt,[n("div",st,v(y.value.monitored_products),1),e[9]||(e[9]=n("div",{class:"label"},"监控商品",-1))])])]),_:1}),t(d,{span:6},{default:a(()=>[n("div",nt,[n("div",{class:Ae(["icon-wrapper",y.value.is_running?"bg-green":"bg-red"])},[y.value.is_running?(u(),h(o,{key:0},{default:a(()=>[t(g(Y))]),_:1})):(u(),h(o,{key:1},{default:a(()=>[t(g(Z))]),_:1}))],2),n("div",ot,[n("div",rt,v(y.value.is_running?"运行中":"已停止"),1),e[10]||(e[10]=n("div",{class:"label"},"监控状态",-1))])])]),_:1}),t(d,{span:6},{default:a(()=>[n("div",it,[n("div",ut,[t(o,null,{default:a(()=>[t(g(Ne))]),_:1})]),n("div",dt,[n("div",ct,v(W(y.value.last_check_time)),1),e[11]||(e[11]=n("div",{class:"label"},"上次检查",-1))])])]),_:1}),t(d,{span:6,class:"actions-col"},{default:a(()=>[t(w,{type:"primary",loading:B.value,onClick:j,icon:g(Re),class:"action-btn"},{default:a(()=>[...e[12]||(e[12]=[_(" 立即检查 ",-1)])]),_:1},8,["loading","icon"]),t(w,{type:y.value.is_running?"danger":"success",onClick:ee,icon:y.value.is_running?g(Z):g(Y),class:"action-btn",plain:""},{default:a(()=>[_(v(y.value.is_running?"停止":"启动"),1)]),_:1},8,["type","icon"])]),_:1})]),_:1}),t(he,{class:"table-card",shadow:"never"},{header:a(()=>[n("div",_t,[n("div",vt,[t(o,null,{default:a(()=>[t(g(Ee))]),_:1}),e[13]||(e[13]=n("span",null,"监控列表",-1))]),t(w,{type:"primary",icon:g(Le),onClick:pe},{default:a(()=>[...e[14]||(e[14]=[_(" 添加商品 ",-1)])]),_:1},8,["icon"])])]),default:a(()=>[Be((u(),h(H,{data:y.value.products,style:{width:"100%"},"row-key":"url"},{empty:a(()=>[t(be,{description:"暂无监控商品"})]),default:a(()=>[t(b,{type:"expand"},{default:a(s=>[n("div",pt,[s.row.status==="coming_soon"?(u(),m("div",ft,[t(me,{title:"商品即将上架",type:"warning",description:"该商品目前标记为即将上架，正在持续监控中。","show-icon":"",closable:!1})])):(u(),h(H,{key:1,data:ce(s.row),size:"small",border:""},{default:a(()=>[t(b,{prop:"size",label:"尺码",width:"120",align:"center"},{default:a(({row:c})=>[t(I,{type:de(c.size,s.row.target_sizes)?"warning":"info",size:"small"},{default:a(()=>[_(v(c.size),1)]),_:2},1032,["type"])]),_:2},1024),t(b,{prop:"color_name",label:"颜色",width:"180","show-overflow-tooltip":""}),t(b,{prop:"stock_status",label:"库存状态",align:"center"},{default:a(({row:c})=>[t(I,{type:c.is_available?"success":"danger",effect:"dark",size:"small"},{default:a(()=>[_(v(c.is_available?"有货":"缺货"),1)]),_:2},1032,["type"])]),_:1})]),_:2},1032,["data"]))])]),_:1}),t(b,{prop:"name",label:"商品名称","min-width":"200"},{default:a(({row:s})=>[n("div",gt,[n("span",mt,v(s.name||"正在获取..."),1),t(I,{size:"small",effect:"plain",type:"info"},{default:a(()=>[_(v(ue(s.url)),1)]),_:2},1024)])]),_:1}),t(b,{label:"目标",width:"200"},{default:a(({row:s})=>[n("div",yt,[(u(!0),m(A,null,N(s.target_sizes,c=>(u(),h(I,{key:c,size:"small",type:"warning",effect:"plain"},{default:a(()=>[_(v(c),1)]),_:2},1024))),128)),s.target_sizes.length?S("",!0):(u(),m("span",bt,"全尺码"))])]),_:1}),t(b,{prop:"status",label:"状态",width:"120",align:"center"},{default:a(({row:s})=>[t(I,{type:_e(s.status),effect:"light"},{default:a(()=>[_(v(ve(s.status)),1)]),_:2},1032,["type"])]),_:1}),t(b,{label:"最后更新",width:"180"},{default:a(({row:s})=>[n("span",ht,v(W(s.last_check_time)),1)]),_:1}),t(b,{label:"操作",width:"150",align:"right"},{default:a(({row:s})=>[t(ye,null,{default:a(()=>[t(w,{link:"",type:"primary",icon:g($e),onClick:c=>ie(s.url)},{default:a(()=>[...e[15]||(e[15]=[_("访问",-1)])]),_:1},8,["icon","onClick"]),t(w,{link:"",type:"danger",icon:g(qe),onClick:c=>re(s.url)},{default:a(()=>[...e[16]||(e[16]=[_("移除",-1)])]),_:1},8,["icon","onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[Ie,R.value]])]),_:1}),t(xe,{modelValue:C.value,"onUpdate:modelValue":e[8]||(e[8]=s=>C.value=s),title:"添加监控商品",width:"600px",onClose:fe,"destroy-on-close":""},{footer:a(()=>[t(w,{onClick:e[7]||(e[7]=s=>C.value=!1)},{default:a(()=>[...e[23]||(e[23]=[_("取消",-1)])]),_:1}),t(w,{type:"primary",onClick:oe,loading:$.value,disabled:!G.value},{default:a(()=>[...e[24]||(e[24]=[_(" 开始监控 ",-1)])]),_:1},8,["loading","disabled"])]),default:a(()=>[t(ze,{modelValue:q.value,"onUpdate:modelValue":e[3]||(e[3]=s=>q.value=s),class:"add-tabs"},{default:a(()=>[t(J,{label:"智能解析",name:"smart"},{default:a(()=>{var s;return[n("div",kt,[t(K,{modelValue:i.value.input,"onUpdate:modelValue":e[0]||(e[0]=c=>i.value.input=c),placeholder:"粘贴商品链接或输入 Key (例如: beta-lt-jacket)","prefix-icon":g(Me),onInput:te,clearable:""},null,8,["modelValue","prefix-icon"]),e[21]||(e[21]=n("div",{class:"tip-text"},"支持 Arc'teryx 和 Scheels 链接/Key",-1)),p.value.success?(u(),m("div",wt,[n("div",Vt,[t(o,null,{default:a(()=>[t(g(Ke))]),_:1}),e[17]||(e[17]=_(" 识别成功 ",-1))]),n("div",zt,[n("div",Ct,[e[18]||(e[18]=n("span",{class:"label"},"站点:",-1)),_(" "+v(p.value.site_name),1)]),n("div",xt,[e[19]||(e[19]=n("span",{class:"label"},"Key:",-1)),_(" "+v(p.value.key),1)]),(s=p.value.categories)!=null&&s.length?(u(),m("div",It,[e[20]||(e[20]=n("span",{class:"label"},"分类:",-1)),t(we,{modelValue:i.value.category,"onUpdate:modelValue":e[1]||(e[1]=c=>i.value.category=c),size:"small",onChange:ne},{default:a(()=>[(u(!0),m(A,null,N(p.value.categories,c=>(u(),h(ke,{key:c.value,value:c.value},{default:a(()=>[_(v(c.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])])):S("",!0)]),n("div",St,[t(Ve,{href:L.value,target:"_blank",type:"primary"},{default:a(()=>[_(v(L.value),1)]),_:1},8,["href"])])])):p.value.error?(u(),m("div",Ut,v(p.value.error),1)):S("",!0)])]}),_:1}),t(J,{label:"手动填写",name:"manual"},{default:a(()=>[t(O,{"label-position":"top"},{default:a(()=>[t(F,{label:"商品链接 (URL)"},{default:a(()=>[t(K,{modelValue:i.value.input,"onUpdate:modelValue":e[2]||(e[2]=s=>i.value.input=s),placeholder:"https://..."},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(Ce,{"content-position":"center"},{default:a(()=>[...e[22]||(e[22]=[_("监控选项",-1)])]),_:1}),t(O,{"label-width":"80px"},{default:a(()=>[t(F,{label:"商品名称"},{default:a(()=>[t(K,{modelValue:i.value.name,"onUpdate:modelValue":e[4]||(e[4]=s=>i.value.name=s),placeholder:"可选，默认自动获取"},null,8,["modelValue"])]),_:1}),t(F,{label:"目标尺码"},{default:a(()=>[t(X,{modelValue:i.value.target_sizes,"onUpdate:modelValue":e[5]||(e[5]=s=>i.value.target_sizes=s),multiple:"",filterable:"","allow-create":"","default-first-option":"",loading:P.value,placeholder:"所有尺码 (支持手动输入)",style:{width:"100%"}},{default:a(()=>[(u(!0),m(A,null,N(z.value,s=>(u(),h(Q,{key:s,label:s,value:s},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"]),p.value.success&&!P.value&&z.value.length===0?(u(),m("div",Pt," 未获取到可选尺码，可手动输入 ")):S("",!0)]),_:1}),t(F,{label:"目标颜色"},{default:a(()=>[t(X,{modelValue:i.value.target_colors,"onUpdate:modelValue":e[6]||(e[6]=s=>i.value.target_colors=s),multiple:"",filterable:"","allow-create":"","default-first-option":"",loading:U.value,placeholder:"所有颜色 (支持手动输入)",style:{width:"100%"}},{default:a(()=>[(u(!0),m(A,null,N(V.value,s=>(u(),h(Q,{key:s.value,label:s.label,value:s.label},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"]),p.value.success&&!U.value&&V.value.length===0?(u(),m("div",Tt," 未获取到可选颜色，可手动输入 ")):S("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}},Rt=Ge(Dt,[["__scopeId","data-v-8d3aaf13"]]);export{Rt as default};
