import{r as f,N as xe,j as Se,O as Ie,c as m,o as i,b as t,w as a,d as o,n as Ue,P as Pe,a as n,f as g,Q as Te,t as v,A as De,B as h,C as X,D as Y,z as Fe,F as Ae,i as _,R as Ne,H as I,I as D,J as F,S as Be,T as $e,U as Ee,V as Le,W as Me,X as Ke,Y as Re,E as k,Z as je,_ as We,$ as He,a0 as Je,a1 as Oe,a2 as Qe,a3 as Xe,a4 as Ye}from"./index-BBqXCmWc.js";import{_ as Ze}from"./_plugin-vue_export-helper-DlAUqK2U.js";const qe={class:"inventory-view"},Ge={class:"stat-card"},et={class:"icon-wrapper bg-blue"},tt={class:"content"},at={class:"value"},lt={class:"stat-card"},st={class:"content"},nt={class:"value"},ot={class:"stat-card"},rt={class:"icon-wrapper bg-purple"},it={class:"content"},ut={class:"value"},dt={class:"card-header"},ct={class:"header-title"},_t={class:"variants-container"},vt={key:0,class:"coming-soon-alert"},pt={class:"product-name-cell"},ft={class:"name-text"},gt={class:"tags-wrapper"},mt={key:0,class:"text-gray"},yt={class:"text-gray"},bt={class:"tab-content"},ht={key:0,class:"parse-success-card"},kt={class:"header"},wt={class:"info-grid"},Vt={class:"item"},zt={class:"item"},Ct={key:0,class:"item full"},xt={class:"preview-link"},St={key:1,class:"parse-error-msg"},It={key:0,class:"tip-text"},Ut={key:0,class:"color-hint"},Pt={__name:"Inventory",setup(Tt){const y=f({is_running:!1,last_check_time:null,monitored_products:0,products:[]}),A=f(!1),N=f(!1),B=f(!1),C=f(!1),$=f("smart"),V=f([]),U=f(!1),z=f([]),P=f(!1);let E=null;const r=f({input:"",name:"",category:"",target_sizes:[],target_colors:[]}),p=f({success:!1,error:null}),L=f("");let M=null;const Z=xe(()=>$.value==="manual"?!!r.value.input:p.value.success||r.value.input&&!p.value.error),x=async()=>{try{const l=await Ue();y.value=l.data}catch(l){console.error(l)}},R=async()=>{var l,e;N.value=!0;try{const u=await Re();k.success(`检查完成: 变动 ${u.data.changes_detected}`),await x()}catch(u){k.error(((e=(l=u.response)==null?void 0:l.data)==null?void 0:e.detail)||"检查失败")}finally{N.value=!1}},q=async()=>{try{y.value.is_running?(await je(),k.success("监控已停止")):(await We(),k.success("监控已启动")),await x()}catch{k.error("操作失败")}},G=()=>{M&&clearTimeout(M),M=setTimeout(ee,500)},ee=async()=>{var e,u;const l=r.value.input.trim();if(V.value=[],z.value=[],!l){p.value={success:!1,error:null};return}try{const d=await Qe(l);p.value=d.data,d.data.success&&(L.value=d.data.url,d.data.category&&(r.value.category=d.data.category),d.data.url&&(te(d.data.url),ae(d.data.url)))}catch(d){p.value={success:!1,error:((u=(e=d.response)==null?void 0:e.data)==null?void 0:u.detail)||"无法解析"}}},te=async l=>{U.value=!0;try{const e=await Xe(l);e.data.success&&e.data.colors&&(V.value=e.data.colors)}catch(e){console.error("获取颜色失败:",e),V.value=[]}finally{U.value=!1}},ae=async l=>{P.value=!0;try{const e=await Ye(l);z.value=Array.isArray(e.data)?e.data:[]}catch(e){console.error("获取尺码失败:",e),z.value=[]}finally{P.value=!1}},le=()=>{},se=async()=>{var l,e;B.value=!0;try{await Oe({input:r.value.input,name:r.value.name,category:r.value.category,target_sizes:r.value.target_sizes,target_colors:r.value.target_colors}),k.success("添加成功"),C.value=!1,R()}catch(u){k.error(((e=(l=u.response)==null?void 0:l.data)==null?void 0:e.detail)||"添加失败")}finally{B.value=!1}},ne=async l=>{try{await He.confirm("确定移除该商品吗?","警告",{type:"warning"}),await Je(l),k.success("已移除"),x()}catch{}},oe=l=>window.open(l,"_blank"),j=l=>l?new Date(l).toLocaleString("zh-CN",{month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"}):"从未",re=l=>l.includes("scheels")?"Scheels":l.includes("arcteryx")?"Arc'teryx":"Site",ie=(l,e)=>!e||!e.length?!0:e.includes(l),ue=l=>{var u;if(console.log("[getFilteredVariants] row.target_colors:",l.target_colors),console.log("[getFilteredVariants] row.variants count:",(u=l.variants)==null?void 0:u.length),!l.variants||!l.variants.length)return[];if(!l.target_colors||!l.target_colors.length)return console.log("[getFilteredVariants] No target_colors, returning all variants"),l.variants;const e=l.variants.filter(d=>d.color_name&&l.target_colors.includes(d.color_name));return console.log("[getFilteredVariants] Filtered count:",e.length),e},de=l=>({available:"success",coming_soon:"warning",unavailable:"danger"})[l]||"info",ce=l=>({available:"现货",coming_soon:"即将上架",unavailable:"缺货"})[l]||l,_e=()=>{r.value={input:"",name:"",category:"",target_sizes:[],target_colors:[]},p.value={success:!1},V.value=[],z.value=[],C.value=!0},ve=()=>{};return Se(()=>{A.value=!0,x().finally(()=>A.value=!1),E=setInterval(x,3e4)}),Ie(()=>{E&&clearInterval(E)}),(l,e)=>{const u=o("el-icon"),d=o("el-col"),w=o("el-button"),pe=o("el-row"),fe=o("el-alert"),S=o("el-tag"),b=o("el-table-column"),W=o("el-table"),ge=o("el-button-group"),me=o("el-empty"),ye=o("el-card"),K=o("el-input"),be=o("el-radio-button"),he=o("el-radio-group"),ke=o("el-link"),H=o("el-tab-pane"),T=o("el-form-item"),J=o("el-form"),we=o("el-tabs"),Ve=o("el-divider"),O=o("el-option"),Q=o("el-select"),ze=o("el-dialog"),Ce=Pe("loading");return i(),m("div",qe,[t(pe,{gutter:20,class:"overview-row"},{default:a(()=>[t(d,{span:6},{default:a(()=>[n("div",Ge,[n("div",et,[t(u,null,{default:a(()=>[t(g(Te))]),_:1})]),n("div",tt,[n("div",at,v(y.value.monitored_products),1),e[9]||(e[9]=n("div",{class:"label"},"监控商品",-1))])])]),_:1}),t(d,{span:6},{default:a(()=>[n("div",lt,[n("div",{class:De(["icon-wrapper",y.value.is_running?"bg-green":"bg-red"])},[y.value.is_running?(i(),h(u,{key:0},{default:a(()=>[t(g(X))]),_:1})):(i(),h(u,{key:1},{default:a(()=>[t(g(Y))]),_:1}))],2),n("div",st,[n("div",nt,v(y.value.is_running?"运行中":"已停止"),1),e[10]||(e[10]=n("div",{class:"label"},"监控状态",-1))])])]),_:1}),t(d,{span:6},{default:a(()=>[n("div",ot,[n("div",rt,[t(u,null,{default:a(()=>[t(g(Fe))]),_:1})]),n("div",it,[n("div",ut,v(j(y.value.last_check_time)),1),e[11]||(e[11]=n("div",{class:"label"},"上次检查",-1))])])]),_:1}),t(d,{span:6,class:"actions-col"},{default:a(()=>[t(w,{type:"primary",loading:N.value,onClick:R,icon:g(Ae),class:"action-btn"},{default:a(()=>[...e[12]||(e[12]=[_(" 立即检查 ",-1)])]),_:1},8,["loading","icon"]),t(w,{type:y.value.is_running?"danger":"success",onClick:q,icon:y.value.is_running?g(Y):g(X),class:"action-btn",plain:""},{default:a(()=>[_(v(y.value.is_running?"停止":"启动"),1)]),_:1},8,["type","icon"])]),_:1})]),_:1}),t(ye,{class:"table-card",shadow:"never"},{header:a(()=>[n("div",dt,[n("div",ct,[t(u,null,{default:a(()=>[t(g(Ee))]),_:1}),e[13]||(e[13]=n("span",null,"监控列表",-1))]),t(w,{type:"primary",icon:g(Le),onClick:_e},{default:a(()=>[...e[14]||(e[14]=[_(" 添加商品 ",-1)])]),_:1},8,["icon"])])]),default:a(()=>[Ne((i(),h(W,{data:y.value.products,style:{width:"100%"},"row-key":"url"},{empty:a(()=>[t(me,{description:"暂无监控商品"})]),default:a(()=>[t(b,{type:"expand"},{default:a(s=>[n("div",_t,[s.row.status==="coming_soon"?(i(),m("div",vt,[t(fe,{title:"商品即将上架",type:"warning",description:"该商品目前标记为即将上架，正在持续监控中。","show-icon":"",closable:!1})])):(i(),h(W,{key:1,data:ue(s.row),size:"small",border:""},{default:a(()=>[t(b,{prop:"size",label:"尺码",width:"120",align:"center"},{default:a(({row:c})=>[t(S,{type:ie(c.size,s.row.target_sizes)?"warning":"info",size:"small"},{default:a(()=>[_(v(c.size),1)]),_:2},1032,["type"])]),_:2},1024),t(b,{prop:"color_name",label:"颜色",width:"180","show-overflow-tooltip":""}),t(b,{prop:"stock_status",label:"库存状态",align:"center"},{default:a(({row:c})=>[t(S,{type:c.is_available?"success":"danger",effect:"dark",size:"small"},{default:a(()=>[_(v(c.is_available?"有货":"缺货"),1)]),_:2},1032,["type"])]),_:1})]),_:2},1032,["data"]))])]),_:1}),t(b,{prop:"name",label:"商品名称","min-width":"200"},{default:a(({row:s})=>[n("div",pt,[n("span",ft,v(s.name||"正在获取..."),1),t(S,{size:"small",effect:"plain",type:"info"},{default:a(()=>[_(v(re(s.url)),1)]),_:2},1024)])]),_:1}),t(b,{label:"目标",width:"200"},{default:a(({row:s})=>[n("div",gt,[(i(!0),m(D,null,F(s.target_sizes,c=>(i(),h(S,{key:c,size:"small",type:"warning",effect:"plain"},{default:a(()=>[_(v(c),1)]),_:2},1024))),128)),s.target_sizes.length?I("",!0):(i(),m("span",mt,"全尺码"))])]),_:1}),t(b,{prop:"status",label:"状态",width:"120",align:"center"},{default:a(({row:s})=>[t(S,{type:de(s.status),effect:"light"},{default:a(()=>[_(v(ce(s.status)),1)]),_:2},1032,["type"])]),_:1}),t(b,{label:"最后更新",width:"180"},{default:a(({row:s})=>[n("span",yt,v(j(s.last_check_time)),1)]),_:1}),t(b,{label:"操作",width:"150",align:"right"},{default:a(({row:s})=>[t(ge,null,{default:a(()=>[t(w,{link:"",type:"primary",icon:g(Be),onClick:c=>oe(s.url)},{default:a(()=>[...e[15]||(e[15]=[_("访问",-1)])]),_:1},8,["icon","onClick"]),t(w,{link:"",type:"danger",icon:g($e),onClick:c=>ne(s.url)},{default:a(()=>[...e[16]||(e[16]=[_("移除",-1)])]),_:1},8,["icon","onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[Ce,A.value]])]),_:1}),t(ze,{modelValue:C.value,"onUpdate:modelValue":e[8]||(e[8]=s=>C.value=s),title:"添加监控商品",width:"600px",onClose:ve,"destroy-on-close":""},{footer:a(()=>[t(w,{onClick:e[7]||(e[7]=s=>C.value=!1)},{default:a(()=>[...e[23]||(e[23]=[_("取消",-1)])]),_:1}),t(w,{type:"primary",onClick:se,loading:B.value,disabled:!Z.value},{default:a(()=>[...e[24]||(e[24]=[_(" 开始监控 ",-1)])]),_:1},8,["loading","disabled"])]),default:a(()=>[t(we,{modelValue:$.value,"onUpdate:modelValue":e[3]||(e[3]=s=>$.value=s),class:"add-tabs"},{default:a(()=>[t(H,{label:"智能解析",name:"smart"},{default:a(()=>{var s;return[n("div",bt,[t(K,{modelValue:r.value.input,"onUpdate:modelValue":e[0]||(e[0]=c=>r.value.input=c),placeholder:"粘贴商品链接或输入 Key (例如: beta-lt-jacket)","prefix-icon":g(Me),onInput:G,clearable:""},null,8,["modelValue","prefix-icon"]),e[21]||(e[21]=n("div",{class:"tip-text"},"支持 Arc'teryx 和 Scheels 链接/Key",-1)),p.value.success?(i(),m("div",ht,[n("div",kt,[t(u,null,{default:a(()=>[t(g(Ke))]),_:1}),e[17]||(e[17]=_(" 识别成功 ",-1))]),n("div",wt,[n("div",Vt,[e[18]||(e[18]=n("span",{class:"label"},"站点:",-1)),_(" "+v(p.value.site_name),1)]),n("div",zt,[e[19]||(e[19]=n("span",{class:"label"},"Key:",-1)),_(" "+v(p.value.key),1)]),(s=p.value.categories)!=null&&s.length?(i(),m("div",Ct,[e[20]||(e[20]=n("span",{class:"label"},"分类:",-1)),t(he,{modelValue:r.value.category,"onUpdate:modelValue":e[1]||(e[1]=c=>r.value.category=c),size:"small",onChange:le},{default:a(()=>[(i(!0),m(D,null,F(p.value.categories,c=>(i(),h(be,{key:c.value,value:c.value},{default:a(()=>[_(v(c.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])])):I("",!0)]),n("div",xt,[t(ke,{href:L.value,target:"_blank",type:"primary"},{default:a(()=>[_(v(L.value),1)]),_:1},8,["href"])])])):p.value.error?(i(),m("div",St,v(p.value.error),1)):I("",!0)])]}),_:1}),t(H,{label:"手动填写",name:"manual"},{default:a(()=>[t(J,{"label-position":"top"},{default:a(()=>[t(T,{label:"商品链接 (URL)"},{default:a(()=>[t(K,{modelValue:r.value.input,"onUpdate:modelValue":e[2]||(e[2]=s=>r.value.input=s),placeholder:"https://..."},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(Ve,{"content-position":"center"},{default:a(()=>[...e[22]||(e[22]=[_("监控选项",-1)])]),_:1}),t(J,{"label-width":"80px"},{default:a(()=>[t(T,{label:"商品名称"},{default:a(()=>[t(K,{modelValue:r.value.name,"onUpdate:modelValue":e[4]||(e[4]=s=>r.value.name=s),placeholder:"可选，默认自动获取"},null,8,["modelValue"])]),_:1}),t(T,{label:"目标尺码"},{default:a(()=>[t(Q,{modelValue:r.value.target_sizes,"onUpdate:modelValue":e[5]||(e[5]=s=>r.value.target_sizes=s),multiple:"",filterable:"","allow-create":"","default-first-option":"",loading:P.value,placeholder:"所有尺码 (支持手动输入)",style:{width:"100%"}},{default:a(()=>[(i(!0),m(D,null,F(z.value,s=>(i(),h(O,{key:s,label:s,value:s},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"]),p.value.success&&!P.value&&z.value.length===0?(i(),m("div",It," 未获取到可选尺码，可手动输入 ")):I("",!0)]),_:1}),t(T,{label:"目标颜色"},{default:a(()=>[t(Q,{modelValue:r.value.target_colors,"onUpdate:modelValue":e[6]||(e[6]=s=>r.value.target_colors=s),multiple:"",filterable:"","allow-create":"","default-first-option":"",loading:U.value,placeholder:"所有颜色 (支持手动输入)",style:{width:"100%"}},{default:a(()=>[(i(!0),m(D,null,F(V.value,s=>(i(),h(O,{key:s.value,label:s.label,value:s.label},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"]),p.value.success&&!U.value&&V.value.length===0?(i(),m("div",Ut," 未获取到可选颜色，可手动输入 ")):I("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}},At=Ze(Pt,[["__scopeId","data-v-1b9e226d"]]);export{At as default};
