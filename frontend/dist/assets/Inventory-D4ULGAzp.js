import{r as g,N as Ve,j as Ce,O as ze,c as y,o as d,b as t,w as a,d as o,n as xe,P as Se,a as n,f,Q as Ie,t as p,A as Ue,B as w,C as J,D as O,z as Te,F as Pe,i as c,R as De,H as U,I as T,J as P,S as Fe,T as Le,U as Ne,V as Be,W as Xe,X as Ae,Y as Me,E as h,Z as $e,_ as Ee,$ as Ke,a0 as Re,a1 as je,a2 as We,a3 as He}from"./index-Tr32eVQh.js";import{_ as Je}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Oe={class:"inventory-view"},Qe={class:"stat-card"},Ye={class:"icon-wrapper bg-blue"},Ze={class:"content"},qe={class:"value"},Ge={class:"stat-card"},et={class:"content"},tt={class:"value"},at={class:"stat-card"},lt={class:"icon-wrapper bg-purple"},st={class:"content"},nt={class:"value"},ot={class:"card-header"},rt={class:"header-title"},it={class:"variants-container"},ut={key:0,class:"coming-soon-alert"},dt={class:"product-name-cell"},ct={class:"name-text"},_t={class:"tags-wrapper"},pt={key:0,class:"text-gray"},vt={class:"text-gray"},ft={class:"tab-content"},mt={key:0,class:"parse-success-card"},gt={class:"header"},yt={class:"info-grid"},bt={class:"item"},ht={class:"item"},kt={key:0,class:"item full"},wt={class:"preview-link"},Vt={key:1,class:"parse-error-msg"},Ct={key:0,class:"color-hint"},zt={__name:"Inventory",setup(xt){const m=g({is_running:!1,last_check_time:null,monitored_products:0,products:[]}),D=g(!1),F=g(!1),L=g(!1),C=g(!1),N=g("smart"),V=g([]),S=g(!1);let B=null;const r=g({input:"",name:"",category:"",target_sizes:[],target_colors:[]}),v=g({success:!1,error:null}),X=g("");let A=null;const Q=Ve(()=>N.value==="manual"?!!r.value.input:v.value.success||r.value.input&&!v.value.error),z=async()=>{try{const l=await xe();m.value=l.data}catch(l){console.error(l)}},$=async()=>{var l,e;F.value=!0;try{const i=await Me();h.success(`检查完成: 变动 ${i.data.changes_detected}`),await z()}catch(i){h.error(((e=(l=i.response)==null?void 0:l.data)==null?void 0:e.detail)||"检查失败")}finally{F.value=!1}},Y=async()=>{try{m.value.is_running?(await $e(),h.success("监控已停止")):(await Ee(),h.success("监控已启动")),await z()}catch{h.error("操作失败")}},Z=()=>{A&&clearTimeout(A),A=setTimeout(q,500)},q=async()=>{var e,i;const l=r.value.input.trim();if(V.value=[],!l){v.value={success:!1,error:null};return}try{const _=await We(l);v.value=_.data,_.data.success&&(X.value=_.data.url,_.data.category&&(r.value.category=_.data.category),_.data.url&&G(_.data.url))}catch(_){v.value={success:!1,error:((i=(e=_.response)==null?void 0:e.data)==null?void 0:i.detail)||"无法解析"}}},G=async l=>{S.value=!0;try{const e=await He(l);e.data.success&&e.data.colors&&(V.value=e.data.colors)}catch(e){console.error("获取颜色失败:",e),V.value=[]}finally{S.value=!1}},ee=()=>{},te=async()=>{var l,e;L.value=!0;try{await je({input:r.value.input,name:r.value.name,category:r.value.category,target_sizes:r.value.target_sizes,target_colors:r.value.target_colors}),h.success("添加成功"),C.value=!1,$()}catch(i){h.error(((e=(l=i.response)==null?void 0:l.data)==null?void 0:e.detail)||"添加失败")}finally{L.value=!1}},ae=async l=>{try{await Ke.confirm("确定移除该商品吗?","警告",{type:"warning"}),await Re(l),h.success("已移除"),z()}catch{}},le=l=>window.open(l,"_blank"),E=l=>l?new Date(l).toLocaleString("zh-CN",{month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"}):"从未",se=l=>l.includes("scheels")?"Scheels":l.includes("arcteryx")?"Arc'teryx":"Site",ne=(l,e)=>!e||!e.length?!0:e.includes(l),oe=l=>{var i;if(console.log("[getFilteredVariants] row.target_colors:",l.target_colors),console.log("[getFilteredVariants] row.variants count:",(i=l.variants)==null?void 0:i.length),!l.variants||!l.variants.length)return[];if(!l.target_colors||!l.target_colors.length)return console.log("[getFilteredVariants] No target_colors, returning all variants"),l.variants;const e=l.variants.filter(_=>_.color_name&&l.target_colors.includes(_.color_name));return console.log("[getFilteredVariants] Filtered count:",e.length),e},re=l=>({available:"success",coming_soon:"warning",unavailable:"danger"})[l]||"info",ie=l=>({available:"现货",coming_soon:"即将上架",unavailable:"缺货"})[l]||l,ue=()=>{r.value={input:"",name:"",category:"",target_sizes:[],target_colors:[]},v.value={success:!1},V.value=[],C.value=!0},de=()=>{};return Ce(()=>{D.value=!0,z().finally(()=>D.value=!1),B=setInterval(z,3e4)}),ze(()=>{B&&clearInterval(B)}),(l,e)=>{const i=o("el-icon"),_=o("el-col"),k=o("el-button"),ce=o("el-row"),_e=o("el-alert"),x=o("el-tag"),b=o("el-table-column"),K=o("el-table"),pe=o("el-button-group"),ve=o("el-empty"),fe=o("el-card"),M=o("el-input"),me=o("el-radio-button"),ge=o("el-radio-group"),ye=o("el-link"),R=o("el-tab-pane"),I=o("el-form-item"),j=o("el-form"),be=o("el-tabs"),he=o("el-divider"),W=o("el-option"),H=o("el-select"),ke=o("el-dialog"),we=Se("loading");return d(),y("div",Oe,[t(ce,{gutter:20,class:"overview-row"},{default:a(()=>[t(_,{span:6},{default:a(()=>[n("div",Qe,[n("div",Ye,[t(i,null,{default:a(()=>[t(f(Ie))]),_:1})]),n("div",Ze,[n("div",qe,p(m.value.monitored_products),1),e[9]||(e[9]=n("div",{class:"label"},"监控商品",-1))])])]),_:1}),t(_,{span:6},{default:a(()=>[n("div",Ge,[n("div",{class:Ue(["icon-wrapper",m.value.is_running?"bg-green":"bg-red"])},[m.value.is_running?(d(),w(i,{key:0},{default:a(()=>[t(f(J))]),_:1})):(d(),w(i,{key:1},{default:a(()=>[t(f(O))]),_:1}))],2),n("div",et,[n("div",tt,p(m.value.is_running?"运行中":"已停止"),1),e[10]||(e[10]=n("div",{class:"label"},"监控状态",-1))])])]),_:1}),t(_,{span:6},{default:a(()=>[n("div",at,[n("div",lt,[t(i,null,{default:a(()=>[t(f(Te))]),_:1})]),n("div",st,[n("div",nt,p(E(m.value.last_check_time)),1),e[11]||(e[11]=n("div",{class:"label"},"上次检查",-1))])])]),_:1}),t(_,{span:6,class:"actions-col"},{default:a(()=>[t(k,{type:"primary",loading:F.value,onClick:$,icon:f(Pe),class:"action-btn"},{default:a(()=>[...e[12]||(e[12]=[c(" 立即检查 ",-1)])]),_:1},8,["loading","icon"]),t(k,{type:m.value.is_running?"danger":"success",onClick:Y,icon:m.value.is_running?f(O):f(J),class:"action-btn",plain:""},{default:a(()=>[c(p(m.value.is_running?"停止":"启动"),1)]),_:1},8,["type","icon"])]),_:1})]),_:1}),t(fe,{class:"table-card",shadow:"never"},{header:a(()=>[n("div",ot,[n("div",rt,[t(i,null,{default:a(()=>[t(f(Ne))]),_:1}),e[13]||(e[13]=n("span",null,"监控列表",-1))]),t(k,{type:"primary",icon:f(Be),onClick:ue},{default:a(()=>[...e[14]||(e[14]=[c(" 添加商品 ",-1)])]),_:1},8,["icon"])])]),default:a(()=>[De((d(),w(K,{data:m.value.products,style:{width:"100%"},"row-key":"url"},{empty:a(()=>[t(ve,{description:"暂无监控商品"})]),default:a(()=>[t(b,{type:"expand"},{default:a(s=>[n("div",it,[s.row.status==="coming_soon"?(d(),y("div",ut,[t(_e,{title:"商品即将上架",type:"warning",description:"该商品目前标记为即将上架，正在持续监控中。","show-icon":"",closable:!1})])):(d(),w(K,{key:1,data:oe(s.row),size:"small",border:""},{default:a(()=>[t(b,{prop:"size",label:"尺码",width:"120",align:"center"},{default:a(({row:u})=>[t(x,{type:ne(u.size,s.row.target_sizes)?"warning":"info",size:"small"},{default:a(()=>[c(p(u.size),1)]),_:2},1032,["type"])]),_:2},1024),t(b,{prop:"color_name",label:"颜色",width:"180","show-overflow-tooltip":""}),t(b,{prop:"stock_status",label:"库存状态",align:"center"},{default:a(({row:u})=>[t(x,{type:u.is_available?"success":"danger",effect:"dark",size:"small"},{default:a(()=>[c(p(u.is_available?"有货":"缺货"),1)]),_:2},1032,["type"])]),_:1})]),_:2},1032,["data"]))])]),_:1}),t(b,{prop:"name",label:"商品名称","min-width":"200"},{default:a(({row:s})=>[n("div",dt,[n("span",ct,p(s.name||"正在获取..."),1),t(x,{size:"small",effect:"plain",type:"info"},{default:a(()=>[c(p(se(s.url)),1)]),_:2},1024)])]),_:1}),t(b,{label:"目标",width:"200"},{default:a(({row:s})=>[n("div",_t,[(d(!0),y(T,null,P(s.target_sizes,u=>(d(),w(x,{key:u,size:"small",type:"warning",effect:"plain"},{default:a(()=>[c(p(u),1)]),_:2},1024))),128)),s.target_sizes.length?U("",!0):(d(),y("span",pt,"全尺码"))])]),_:1}),t(b,{prop:"status",label:"状态",width:"120",align:"center"},{default:a(({row:s})=>[t(x,{type:re(s.status),effect:"light"},{default:a(()=>[c(p(ie(s.status)),1)]),_:2},1032,["type"])]),_:1}),t(b,{label:"最后更新",width:"180"},{default:a(({row:s})=>[n("span",vt,p(E(s.last_check_time)),1)]),_:1}),t(b,{label:"操作",width:"150",align:"right"},{default:a(({row:s})=>[t(pe,null,{default:a(()=>[t(k,{link:"",type:"primary",icon:f(Fe),onClick:u=>le(s.url)},{default:a(()=>[...e[15]||(e[15]=[c("访问",-1)])]),_:1},8,["icon","onClick"]),t(k,{link:"",type:"danger",icon:f(Le),onClick:u=>ae(s.url)},{default:a(()=>[...e[16]||(e[16]=[c("移除",-1)])]),_:1},8,["icon","onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[we,D.value]])]),_:1}),t(ke,{modelValue:C.value,"onUpdate:modelValue":e[8]||(e[8]=s=>C.value=s),title:"添加监控商品",width:"600px",onClose:de,"destroy-on-close":""},{footer:a(()=>[t(k,{onClick:e[7]||(e[7]=s=>C.value=!1)},{default:a(()=>[...e[23]||(e[23]=[c("取消",-1)])]),_:1}),t(k,{type:"primary",onClick:te,loading:L.value,disabled:!Q.value},{default:a(()=>[...e[24]||(e[24]=[c(" 开始监控 ",-1)])]),_:1},8,["loading","disabled"])]),default:a(()=>[t(be,{modelValue:N.value,"onUpdate:modelValue":e[3]||(e[3]=s=>N.value=s),class:"add-tabs"},{default:a(()=>[t(R,{label:"智能解析",name:"smart"},{default:a(()=>{var s;return[n("div",ft,[t(M,{modelValue:r.value.input,"onUpdate:modelValue":e[0]||(e[0]=u=>r.value.input=u),placeholder:"粘贴商品链接或输入 Key (例如: beta-lt-jacket)","prefix-icon":f(Xe),onInput:Z,clearable:""},null,8,["modelValue","prefix-icon"]),e[21]||(e[21]=n("div",{class:"tip-text"},"支持 Arc'teryx 和 Scheels 链接/Key",-1)),v.value.success?(d(),y("div",mt,[n("div",gt,[t(i,null,{default:a(()=>[t(f(Ae))]),_:1}),e[17]||(e[17]=c(" 识别成功 ",-1))]),n("div",yt,[n("div",bt,[e[18]||(e[18]=n("span",{class:"label"},"站点:",-1)),c(" "+p(v.value.site_name),1)]),n("div",ht,[e[19]||(e[19]=n("span",{class:"label"},"Key:",-1)),c(" "+p(v.value.key),1)]),(s=v.value.categories)!=null&&s.length?(d(),y("div",kt,[e[20]||(e[20]=n("span",{class:"label"},"分类:",-1)),t(ge,{modelValue:r.value.category,"onUpdate:modelValue":e[1]||(e[1]=u=>r.value.category=u),size:"small",onChange:ee},{default:a(()=>[(d(!0),y(T,null,P(v.value.categories,u=>(d(),w(me,{key:u.value,value:u.value},{default:a(()=>[c(p(u.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])])):U("",!0)]),n("div",wt,[t(ye,{href:X.value,target:"_blank",type:"primary"},{default:a(()=>[c(p(X.value),1)]),_:1},8,["href"])])])):v.value.error?(d(),y("div",Vt,p(v.value.error),1)):U("",!0)])]}),_:1}),t(R,{label:"手动填写",name:"manual"},{default:a(()=>[t(j,{"label-position":"top"},{default:a(()=>[t(I,{label:"商品链接 (URL)"},{default:a(()=>[t(M,{modelValue:r.value.input,"onUpdate:modelValue":e[2]||(e[2]=s=>r.value.input=s),placeholder:"https://..."},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(he,{"content-position":"center"},{default:a(()=>[...e[22]||(e[22]=[c("监控选项",-1)])]),_:1}),t(j,{"label-width":"80px"},{default:a(()=>[t(I,{label:"商品名称"},{default:a(()=>[t(M,{modelValue:r.value.name,"onUpdate:modelValue":e[4]||(e[4]=s=>r.value.name=s),placeholder:"可选，默认自动获取"},null,8,["modelValue"])]),_:1}),t(I,{label:"目标尺码"},{default:a(()=>[t(H,{modelValue:r.value.target_sizes,"onUpdate:modelValue":e[5]||(e[5]=s=>r.value.target_sizes=s),multiple:"",placeholder:"所有尺码",style:{width:"100%"}},{default:a(()=>[(d(),y(T,null,P(["XS","S","M","L","XL","2XL","XXL"],s=>t(W,{key:s,label:s,value:s},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),t(I,{label:"目标颜色"},{default:a(()=>[t(H,{modelValue:r.value.target_colors,"onUpdate:modelValue":e[6]||(e[6]=s=>r.value.target_colors=s),multiple:"",filterable:"","allow-create":"","default-first-option":"",loading:S.value,placeholder:"所有颜色 (支持手动输入)",style:{width:"100%"}},{default:a(()=>[(d(!0),y(T,null,P(V.value,s=>(d(),w(W,{key:s.value,label:s.label,value:s.label},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"]),v.value.success&&!S.value&&V.value.length===0?(d(),y("div",Ct," 未获取到可选颜色，可手动输入 ")):U("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}},Ut=Je(zt,[["__scopeId","data-v-86a3a2bc"]]);export{Ut as default};
